name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  JAVA_VERSION: '17'

jobs:
  # Ð¡Ñ‚Ð°Ð´Ð¸Ñ build - Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ SBOM
  generate-sbom:
    name: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ mvnw
        run: chmod +x ./mvnw

      - name: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ SBOM (CycloneDX)
        run: ./mvnw cyclonedx:makeAggregateBom -DskipTests -q

      - name: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° SBOM Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: target/sbom.json
          retention-days: 7

  # Ð¡Ñ‚Ð°Ð´Ð¸Ñ security - OWASP Dependency Check
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ mvnw
        run: chmod +x ./mvnw

      - name: Ð—Ð°Ð¿ÑƒÑÐº Dependency Check
        run: ./mvnw dependency-check:check -DskipTests -DnvdApiKey="${{ secrets.NVD_API_KEY }}" -q
        continue-on-error: true

      - name: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° Dependency Check
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: target/dependency-check/
          retention-days: 7

  build:
    name: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ñ‚ÐµÑÑ‚Ñ‹
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ mvnw
        run: chmod +x ./mvnw

      - name: ÐšÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Maven Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        run: ./mvnw compile -q -DskipSpotlessCheck=true

      - name: Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼
        run: ./mvnw test jacoco:report -q -DskipSpotlessCheck=true

      - name: Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÐºÐ¾Ð´Ð°
        id: coverage
        run: |
          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¸Ð· CSV Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°
          # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ JaCoCo CSV: GROUP,PACKAGE,CLASS,INSTRUCTION_MISSED,INSTRUCTION_COVERED,...
          if [ -f target/site/jacoco/jacoco.csv ]; then
            MISSED=$(awk -F',' 'NR>1 {sum+=$4} END {print sum}' target/site/jacoco/jacoco.csv)
            COVERED=$(awk -F',' 'NR>1 {sum+=$5} END {print sum}' target/site/jacoco/jacoco.csv)
            TOTAL=$((COVERED + MISSED))
            if [ $TOTAL -gt 0 ]; then
              PERCENT=$((COVERED * 100 / TOTAL))
              echo "coverage=${PERCENT}%" >> $GITHUB_OUTPUT
              echo "## ðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ ÐºÐ¾Ð´Ð°" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| ÐœÐµÑ‚Ñ€Ð¸ÐºÐ° | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|----------|" >> $GITHUB_STEP_SUMMARY
              echo "| ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¹ | **${PERCENT}%** |" >> $GITHUB_STEP_SUMMARY
              echo "| ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ | ${COVERED} |" >> $GITHUB_STEP_SUMMARY
              echo "| ÐŸÑ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ | ${MISSED} |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° JaCoCo
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/
          retention-days: 14

      - name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ° JAR
        run: ./mvnw verify -DskipTests -q -DskipSpotlessCheck=true
        continue-on-error: true

      - name: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 7

  lint:
    name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð¸Ð»Ñ ÐºÐ¾Ð´Ð°
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ mvnw
        run: chmod +x ./mvnw

      - name: ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Spotless
        run: ./mvnw spotless:apply -q

      - name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (Spotless)
        run: ./mvnw spotless:check -q

      - name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð¸Ð»Ñ (Checkstyle)
        run: ./mvnw checkstyle:check -q
        continue-on-error: true

      - name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ÑÐ»Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
        run: |
          if git diff --quiet; then
            echo "âœ… ÐšÐ¾Ð´ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð°Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ 'mvn spotless:apply' Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾." >> $GITHUB_STEP_SUMMARY
            git diff --stat
          fi
